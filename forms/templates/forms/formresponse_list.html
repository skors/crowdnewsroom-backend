{% extends "./investigation_list.html" %}
{% load i18n %}
{% load forms_tags %}
{% load tz %}

{% block title %}{% trans "Responses" %}{% endblock %}
{% block headertitle %}
    {% blocktrans with name=form.name %}
        Responses for {{ name }}
    {% endblocktrans %}
{% endblock %}

{% block main %}
  <div class="formresponse-list">
      <div style="width:100%; height: 400px;">
          <canvas id="canvas"></canvas>
      </div>
      <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.kwargs.bucket == 'inbox' %} active {% endif %}" href="inbox">
            <i class="fa {% response_icon 'S' %}"></i>
            Inbox
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.kwargs.bucket == 'verified' %} active {% endif %}" href="verified">
            <i class="fa {% response_icon 'V' %}"></i>
            Verified
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.kwargs.bucket == 'trash' %} active {% endif %}" href="trash">
            <i class="fa {% response_icon 'I' %}"></i>
            Trash
        </a>
      </li>
    </ul>
      <form action="" method="GET">
          <label for="has_filter">{% trans "Only show responses that have" %}</label>
          <select id="has_filter" name="has" onChange="this.form.submit()">
              <option value="">---</option>
              {% for property in form.instance_properties %}
              <option value="{{property}}"
                      {% if has_query_param == property %} selected {% endif %}
              >{{property}}</option>
              {% endfor %}
          </select>
      </form>
    <table class="table">
        <tr>
            <td>{% trans "Email" %}</td>
            <td>{% trans "Date" %}</td>
            <td>{% trans "Comments" %}</td>
        </tr>
        {% for response in formresponse_list %}
            <tr>
                <td>
                    <a href="{% url "response_details" investigation.slug form.slug response.id %}"
                        style="text-decoration: none">
                        <i class="fa {% response_icon response.status %}"></i>
                        {% if response.json_email %}
                            {{ response.json_email }}
                        {% else %}
                            <i> {% trans "No Email Provided" %}</i>
                        {% endif %}
                    </a>
                </td>
                <td>{{ response.submission_date | localtime }}</td>
                <td>{{ response.comment_set.count }}</td>
            </tr>
        {% endfor %}
    </table>
      {% if is_paginated %}
        <div class="responses-pagination">
            <div class="page-links">
                {% if page_obj.has_previous %}
                    <a href="?has={{ has_query_param }}&page={{ page_obj.previous_page_number }}">{% trans "previous" %}</a>
                {% endif %}
                <span class="page-current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
                {% if page_obj.has_next %}
                    <a href="?has={{ has_query_param }}&page={{ page_obj.next_page_number }}">{% trans "next" %}</a>
                {% endif %}
            </div>
            <div class="total">
                Total results: {{ paginator.count }}
            </div>
        </div>
    {% endif %}
    <a href="{% url "form_responses_csv" investigation.slug form.slug %}">
      <i class="fa fa-download"></i>
      {% trans "Download data as csv" %}
      </a>
  </div>

<script>
const labels = [
{% for entry in form.submissions_by_date %}
            new Date({{ entry.date | date:"U" }} * 1000),
{% endfor %}
            ];
const values  = [
{% for entry in form.submissions_by_date %}
            {{ entry.c }},
{% endfor %}
];
window.addEventListener("load", function(event){
    makeChart(labels, values);
});
</script>

{% endblock %}
