{% extends "./investigation_list.html" %}
{% load i18n %}
{% load forms_tags %}
{% load tz %}

{% block title %}{% trans "Responses" %}{% endblock %}
{% block headertitle %}
    {% blocktrans with name=form.name %}
        Responses for {{ name }}
    {% endblocktrans %}
{% endblock %}

{% block main %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.0/moment.min.js" ></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
  <div class="formresponse-list">
    <div style="width:100%; height: 400px;">
		<canvas id="canvas"></canvas>
    </div>
    <form action="" method="GET">
        <label for="has_filter">{% trans "Only show responses that have" %}</label>
        <select id="has_filter" name="has" onChange="this.form.submit()">
            <option value="">---</option>
            {% for property in form.instance_properties %}
            <option value="{{property}}"
                    {% if request.GET.has == property %} selected {% endif %}
            >{{property}}</option>
            {% endfor %}
        </select>
    </form>

    <table class="table">
        <tr>
            <td>{% trans "Response" %}</td>
            <td>{% trans "Status" %}</td>
            <td>{% trans "Comments" %}</td>
        </tr>
        {% for response in formresponse_list %}
            <tr>
                <td>
                    <a href="{% url "response_details" investigation.slug form.slug response.id %}"
                        style="text-decoration: none">
                        <i class="fa {% response_icon response.status %}"></i>
                        {{ response.json_email }} - {{ response.submission_date | localtime }}
                    </a>
                </td>
                <td>{{ response.get_status_display }}</td>
                <td>{{ response.comment_set.count }}</td>
            </tr>
        {% endfor %}
    </table>
      {% if is_paginated %}
        <div class="responses-pagination">
            <div class="page-links">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}">{% trans "previous" %}</a>
                {% endif %}
                <span class="page-current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">{% trans "next" %}</a>
                {% endif %}
            </div>
            <div class="total">
                Total results: {{ paginator.count }}
            </div>
        </div>
    {% endif %}
    <a href="{% url "form_responses_csv" investigation.slug form.slug %}">
      <i class="fa fa-download"></i>
      {% trans "Download data as csv" %}
      </a>
  </div>

<script>
const labels = [
{% for entry in form.submissions_by_date %}
            new Date({{ entry.date | date:"U" }} * 1000),
{% endfor %}
            ];
const values  = [
{% for entry in form.submissions_by_date %}
            {{ entry.c }},
{% endfor %}
];
var timeFormat = 'MM/DD/YYYY HH:mm';

		var color = Chart.helpers.color;
		var config = {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: 'Contributions',
					backgroundColor: color("red").alpha(0.5).rgbString(),
					borderColor: "red",
					fill: false,
					data: values,
				}]
			},
			options: {
				scales: {
					xAxes: [{
						type: 'time',
						time: {
							format: timeFormat,
							//round: 'day'
							tooltipFormat: 'll HH:mm'
						},
						scaleLabel: {
							display: true,
							labelString: 'Date'
						}
					}],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'Submissions'
						},
						ticks: {
						    beginAtZero: true
						},
					}]
				},
			}
		};

		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);

		};
</script>

{% endblock %}
